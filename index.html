<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Test GPX + Map</title>
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet + GPX plugin -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-gpx@1.4.0/gpx.min.js"></script>

<script>
  // 1) Maak de kaart en voeg de tiles toe
  const map = L.map('map').setView([50.85,4.35], 13);
  L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', 
    { maxZoom: 19 }
  ).addTo(map);

  // 2) Laad je standaard GPX (in dezelfde map als deze HTML)
  const defaultGpx = 'mijnroute.gpx';  // **Zorg dat dit bestand bestaat**

  new L.GPX(defaultGpx, {async: true})
    .on('loaded', e => {
      // wanneer geladen, zoom naar de route
      map.fitBounds(e.target.getBounds());
    })
    .on('error', err => {
      console.error('Kon GPX niet laden:', err);
    })
    .addTo(map);

  // ─── TRACCAR CONFIGURATIE ─────────────────────────────────────────────────
const config = {
  trackerApiUrl:    'https://demo.traccar.org/api/positions',
  trackerDeviceIds: [7198],        // jouw deviceId(s)
  username:         'kevin.sneyders@gmail.com',        // je Traccar gebruikersnaam
  password:         'K3v1nSn34d3rs',        // je Traccar wachtwoord
  refreshInterval:  10000          // update elke 10s
};

// ─── HULPFUNCTIES ────────────────────────────────────────────────────────────
// Haversine‐formule voor afstand tussen twee punten (in meters)
function haversine(a, b) {
  const R = 6371000;
  const toRad = d => d * Math.PI/180;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lng - a.lng);
  const A = Math.sin(dLat/2)**2 +
            Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) *
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
}

// Bereken resterende afstand t.o.v. de ingeladen GPX-route
function calculateRemainingDistance(pos) {
  if (!routeCoords || !routeCoords.length) return null;
  let closestIdx = 0, minDist = Infinity;
  routeCoords.forEach((pt,i) => {
    const d = haversine(pos, pt);
    if (d < minDist) { minDist = d; closestIdx = i; }
  });
  // som vanaf dichtstbijzijnde punt naar het einde
  let rem = 0;
  for (let i = closestIdx; i < routeCoords.length - 1; i++) {
    rem += haversine(routeCoords[i], routeCoords[i+1]);
  }
  return {
    remainingKm: rem/1000,
    progressPct: totalRouteDistance
      ? 100 - (rem/totalRouteDistance)*100
      : null
  };
}

// ─── TRACKER LOGICA ─────────────────────────────────────────────────────────
const trackerMarkers = {};  // cache van deviceId → Leaflet marker

async function updateTrackers() {
  try {
    const res = await fetch(config.trackerApiUrl, {
      headers: {
        'Authorization': 'Basic ' + btoa(`${config.username}:${config.password}`)
      }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const list = document.getElementById('trackerList');
    list.innerHTML = '';

    config.trackerDeviceIds.forEach(id => {
      const device = data.find(d => d.deviceId === id);
      if (!device) return;

      const { latitude, longitude, fixTime } = device;
      const latlng = { lat: latitude, lng: longitude };

      // maak of verplaats marker
      if (!trackerMarkers[id]) {
        trackerMarkers[id] = L.marker(latlng).addTo(map);
      } else {
        trackerMarkers[id].setLatLng(latlng);
      }

      // bereken afstand & voortgang
      const dist = calculateRemainingDistance(latlng);
      const age = Math.floor((Date.now() - new Date(fixTime)) / 1000);

      // bouw list‐item
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>Tracker ${id}</strong><br>
        (${latitude.toFixed(5)}, ${longitude.toFixed(5)})<br>
        Laatste update: ${age}s geleden<br>
        ${dist
          ? `Nog ${dist.remainingKm.toFixed(2)} km
             <div class="progress-bar">
               <div class="progress-bar-inner" style="width:${dist.progressPct.toFixed(1)}%"></div>
             </div>`
          : 'GPX niet geladen'}  
      `;
      list.appendChild(li);
    });

  } catch (err) {
    console.error('Tracker update mislukt:', err);
  }
}

// ─── OPSTARTEN ──────────────────────────────────────────────────────────────
// Na DOMContentLoaded (en nadat je GPX hebt geladen):
window.addEventListener('DOMContentLoaded', () => {
  // zorg dat routeCoords & totalRouteDistance al ingesteld zijn door GPX‐loader!
  
  // Eerste update
  updateTrackers();
  // Plan periodieke updates
  setInterval(updateTrackers, config.refreshInterval);
});

</script>

</body>
</html>
